
-- 1) 메뉴 테이블
CREATE TABLE MENU_INFO (
	MPART    NUMBER,
	PARTNAME VARCHAR(20),
	MNO      NUMBER PRIMARY KEY, -- 기본키
	MNAME    VARCHAR(20) UNIQUE,
	MPRICE   NUMBER
);

INSERT INTO MENU_INFO VALUES (1000, '커피', 1001, '에스프레소', 2500);
INSERT INTO MENU_INFO VALUES (1000, '커피', 1002, '아메리카노', 4000);
INSERT INTO MENU_INFO VALUES (1000, '커피',  1003, '라떼', 5000);
INSERT INTO MENU_INFO VALUES (1000, '커피',  1004, '카페모카', 5500);
INSERT INTO MENU_INFO VALUES (2000, '논커피',  2001, '초코우유', 2500);
INSERT INTO MENU_INFO VALUES (2000, '논커피',  2002, '녹차', 2500);
INSERT INTO MENU_INFO VALUES (2000, '논커피',  2003, '홍차', 2500);
INSERT INTO MENU_INFO VALUES (2000, '논커피',  2004, '밀크티', 2500);

SELECT * FROM MENU_INFO;
DROP TABLE MENU_INFO;


-- 2) 옵션 코드 테이블
CREATE TABLE OPTION_CODE_INFO (
	OPTION_CODE   VARCHAR(20) PRIMARY KEY,
	OPTION_NAME   VARCHAR(20)
);

INSERT INTO OPTION_CODE_INFO VALUES ('001', '사이즈 업');
INSERT INTO OPTION_CODE_INFO VALUES ('002', '샷 추가');
INSERT INTO OPTION_CODE_INFO VALUES ('003', '시럽 추가');

SELECT * FROM OPTION_CODE_INFO;

-- 3) 상품별 옵션 정보 테이블
CREATE TABLE OPTION_INFO (
	MNO           NUMBER,
	OPTION_CODE   VARCHAR(20),
	OPTION_PRICE  NUMBER
);

INSERT INTO OPTION_INFO VALUES (1001, '002', 500);
INSERT INTO OPTION_INFO VALUES (1002, '001', 500);
INSERT INTO OPTION_INFO VALUES (1002, '002', 500);
INSERT INTO OPTION_INFO VALUES (1002, '003', 300);
INSERT INTO OPTION_INFO VALUES (1003, '001', 500);
INSERT INTO OPTION_INFO VALUES (1003, '002', 500);
INSERT INTO OPTION_INFO VALUES (1003, '003', 300);
INSERT INTO OPTION_INFO VALUES (1004, '001', 500);
INSERT INTO OPTION_INFO VALUES (1004, '002', 500);
INSERT INTO OPTION_INFO VALUES (1004, '003', 300);
INSERT INTO OPTION_INFO VALUES (2001, '001', 500);


SELECT * FROM OPTION_INFO;
DROP TABLE OPTION_INFO;

------------------------------------------------------------------
-- 어떤 메뉴를 선택하시겠습니까? (한글로 선택할 것)
SELECT MNO, MNAME, MPRICE
FROM MENU_INFO;


-- 옵션을 선택해주세요
SELECT C.OPTION_CODE, C.OPTION_NAME
FROM MENU_INFO M
INNER JOIN OPTION_INFO O ON M.MNO = O.MNO
INNER JOIN OPTION_CODE_INFO C ON O.OPTION_CODE = C.OPTION_CODE
WHERE M.MNAME = '아메리카노';

------------------------------------------------------------------

-- 4) 주문 테이블
CREATE TABLE ORDER_INFO (
    ORDER_DATE  DATE,
    ORDER_NO    NUMBER DEFAULT 0 PRIMARY KEY,
    MNO         NUMBER,
--    MNAME VARCHAR2(30),
--        FOREIGN KEY(MNAME) REFERENCES MENU_INFO(MNAME),
    PRICE NUMBER DEFAULT 0
);

-- SET @MNAME = '아메리카노';
-- SET @MNO = (SELECT MNO FROM MENU_INFO WHERE MNAME = @MNAME);
--    
INSERT INTO ORDER_INFO (ORDER_DATE, ORDER_NO, MNO) 
    VALUES (SYSDATE, SEQ_ORDER_NO.NEXTVAL, '1002');
    
INSERT INTO ORDER_INFO (ORDER_DATE, ORDER_NO, MNO)
    VALUES (SYSDATE, SEQ_ORDER_NO.NEXTVAL, '1003');

INSERT INTO ORDER_INFO (ORDER_DATE, ORDER_NO, MNO)
    VALUES (SYSDATE, SEQ_ORDER_NO.NEXTVAL, '1004');
    
SELECT * FROM ORDER_INFO;
DROP TABLE ORDER_INFO;

CREATE SEQUENCE SEQ_ORDER_NO
START WITH 1 -- 몇번부터 시작할래
INCREMENT BY 1  -- 몇씩 증가시킬 것인가.
NOCYCLE -- 반복하지 않음
NOCACHE;

DROP SEQUENCE SEQ_ORDER_NO;

------------------------------------------------------------------
-- 5) 주문 상세 테이블 (옵션 선택)
CREATE TABLE ORDER_DETAIL (
    ORDER_NO NUMBER,  
        FOREIGN KEY(ORDER_NO)REFERENCES ORDER_INFO(ORDER_NO),
    OPTION_CODE VARCHAR(20),
    OPTION_COUNT NUMBER
);
    
INSERT INTO ORDER_DETAIL(ORDER_NO, OPTION_CODE, OPTION_COUNT) 
    VALUES (1, '002', 1);
INSERT INTO ORDER_DETAIL(ORDER_NO, OPTION_CODE, OPTION_COUNT) 
    VALUES (2, '003', 1);
INSERT INTO ORDER_DETAIL(ORDER_NO, OPTION_CODE, OPTION_COUNT) 
    VALUES (3, '001', 1);
INSERT INTO ORDER_DETAIL(ORDER_NO, OPTION_CODE, OPTION_COUNT) 
    VALUES (3, '002', 1);

SELECT * FROM ORDER_DETAIL;
DROP TABLE ORDER_DETAIL;

------------------------------------------------------------------
-- 6) 영수증
SELECT OI.ORDER_DATE AS 날짜, 
    M.MNAME AS 메뉴명, 
    LISTAGG(CI.OPTION_NAME, ',') WITHIN GROUP(ORDER BY CI.OPTION_NAME) AS 옵션,
    OI.PRICE AS 총금액
FROM ORDER_INFO OI 
    INNER JOIN MENU_INFO M
        ON OI.MNO = M.MNO
    LEFT JOIN ORDER_DETAIL D
        ON OI.ORDER_NO = D.ORDER_NO   
    LEFT JOIN OPTION_CODE_INFO CI            
        ON CI.OPTION_CODE = D.OPTION_CODE
GROUP BY OI.ORDER_DATE, M.MNAME, OI.PRICE;
    

-- 총액 > ORDER_INFO 테이블 PRICE에 UPDATE
UPDATE ORDER_INFO OI
    SET OI.PRICE = (SELECT M.MPRICE + NVL(SUM(OPTION_PRICE * OPTION_COUNT), 0)
    FROM  ORDER_INFO OI 
    LEFT JOIN ORDER_DETAIL D -- ORDER_INFO 데이터를 무조건 가져오겠다! 
        ON OI.ORDER_NO = D.ORDER_NO
    INNER JOIN MENU_INFO M 
        ON OI.MNO = M.MNO
    LEFT JOIN OPTION_INFO I 
        ON D.OPTION_CODE = I.OPTION_CODE 
            AND OI.MNO = I.MNO
    WHERE OI.ORDER_NO = '3'
    GROUP BY M.MPRICE)
    WHERE OI.ORDER_NO = '3';

SELECT * FROM ORDER_INFO;
    

SELECT *
    FROM  ORDER_INFO OI 
    LEFT JOIN ORDER_DETAIL D -- ORDER_INFO 데이터를 무조건 가져오겠다! 
        ON OI.ORDER_NO = D.ORDER_NO
    INNER JOIN MENU_INFO M 
        ON OI.MNO = M.MNO
    LEFT JOIN OPTION_INFO I 
        ON D.OPTION_CODE = I.OPTION_CODE 
            AND OI.MNO = I.MNO
    WHERE OI.ORDER_NO = '3'
--    GROUP BY M.MPRICE   ;
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

